---
title: "Windows 中的 UAC 用户账户控制"
date: 2019-03-17 19:17:45 +0800
categories: windows
position: knowledge
---

阅读本文，你可以初步了解 Windows 上的 UAC 用户账户控制机制。本文不会涉及到 UAC 的底层实现原理和安全边界问题。

---

<div id="toc"></div>

## 用户账户

在 Windows 中有多种不同的账户：

- SYSTEM
- 管理员账户
    - Administrator
    - 管理员账户
- 标准账户

我们需要将这些账户列举出来是因为在解释 UAC 账户控制的时候，会与此相关。

SYSTEM 在系统中拥有最高权限。

默认我们安装 Windows 时会创建一个管理员账户，这也是 Windows 系统推荐我们使用的管理员账户，其权限等级比 SYSTEM 低。

Administrator 的权限级别和我们用户创建的管理员账户的权限级别是一样的，但是访问令牌（Access Token）的管理方式不一样，所以这里我们需要分开说。

标准账户是我推荐大家使用的首选账户种类，因为在普通使用场景下，这个是最安全的。

## UAC 通知等级

![用户账户控制设置](/static/posts/2019-03-17-18-42-26.png)

Windows Vista 开始引入了 UAC，不过在 Windows Vista 上只有两种 UAC 设置——开启和关闭。如果开启，那么应用试图安装软件或更改计算机、或者更改了 Windows 设置时将弹出 UAC 提示框；如果关闭，那么 UAC 就此关闭。Windows Vista 的 UAC 一直饱受诟病就是因为这种情况下的 UAC 提示是非常频繁的（而且以前的程序迁移到不需要管理员权限需要时间）。

在 Windows 7 上，在开启和关闭中间新引入了两个 UAC 级别，都是在更改 Windows 设置时不通知。只是一个会进入“黑屏”状态，另一个不会进入此状态。从表现上看这两个只是黑屏与不黑屏，但从安全性上讲黑屏的安全性会高很多。因为黑屏状态下整个桌面进入了 SYSTEM 账户，原用户账户下的所有程序都无法得知此时 UAC 弹窗的情况，也无法通过模拟用户操作来跳过这个 UAC 框。而不黑屏时，不会切换到新的桌面环境，原有程序依然可以获得此 UAC 弹窗的一些信息，这很不安全。

但是！无论是 Windows Vista 还是 Windows 7，一旦你将 UAC 设置拖到最底，那么此时 UAC 将彻底关闭。如果你是管理员账户，那么运行的程序都将以管理员权限运行。

从 Windows 8 开始到现在的 Windows 10，虽然依然是上面四个设置，但拖到最底的“从不通知”时，UAC 依然是开启的状态。也就是说，用户正常启动的进程依然是标准权限，要获得管理员权限提升依然需要重启整个进程。这个安全性限制是很重要的。

## 访问令牌

进程在创建的时候，可以得到一个访问令牌（Access Token），这个令牌不同决定了此程序在运行时可以访问的系统资源不同。

- SYSTEM 令牌
- 完全访问令牌（Full Access Token）
- 受限访问令牌（Limited Access Token）

标准账户以及普通的管理员账户在运行程序的时候，进程会获得受限访问令牌。

普通管理员账户下，正常启动进程使用的是受限访问令牌。当进程需要提升权限时，会弹出 UAC 提示框来启动一个子进程以获得完全访问令牌。

Administrator 账户下，正常启动的进程也都是管理员权限，会获得完全访问令牌。

如果你的管理员账户关闭了 UAC，那么效果就和 Administrator 一样。

一个服务进程通常是 SYSTEM 权限，会获得 SYSTEM 访问令牌，具有完全访问权限。

## 权限提升

在 Windows 系统中，不同权限的进程是隔离的（虽然不是完全隔离）。

如果你希望你的程序在执行某个操作的时候提升权限来执行，实际上你不能在你原来的进程上直接提升权限。你有很多种方法来提权，甚至绕过 UAC 来提权，但无论哪一种，你的进程实际上都是重启了，你是在新的提升的进程中执行了这个需要权限的操作。

对于管理员账户，如果启动一个普通进程，那么此进程在管理员账户下运行，获得的是受限访问令牌。当此进程提升权限，将弹出 UAC 提示框，用户同意后继续使用此同一个管理员账户运行，但子进程将获得完全访问令牌。

对于标准账户，如果启动一个普通进程，那么此进程在标准账户下运行，获得的是受限访问令牌。当此进程提升权限，将弹出 UAC 提示框，用户输入管理员账号密码后，子进程将在输入的管理员账户下运行，获得此管理员的完全访问令牌。**标准账户没有完全访问令牌**，如果说绕过 UAC 来提权是为了获取完全访问令牌，那么在标准账户下根本没有完全访问令牌，所以你绕不过。

管理员账户的 UAC 弹窗是这样的，要求用户选“是”或者“否”：

![UAC 弹窗](/static/posts/2019-03-17-16-42-45.png)

而标准账户的 UAC 弹窗是这样的，要求输入管理员账号和密码：


以上在标准账户下用管理员账户打开子进程的例子可以看下图：

![标准账户下运行管理员权限程序会切换账户](/static/posts/2019-03-17-16-57-48.png)

lvyi 是我安装系统时创建的管理员账号，但是我使用的是 walterlv 标准账号。正常是在 walterlv 账号下启动程序，但以管理员权限运行时，会要求输入 lvyi 账号的密码来提权，于是就会以 lvyi 的身份运行这个程序。这种情况下，那个管理员权限运行的程序会以为当前运行在 lvyi 这个账户下，程序员需要小心这里的坑，因为拿到的用户路径以及注册表不是你所期望的 walterlv 这个账号下的。

在上图中，你会发现当前账户下的任务管理器连管理员账户运行的程序图标都拿不到。
